# Welcome to TwitterDataSourcingCDK

## Implementation

![StreamDataSourcing-Page-3 drawio](https://user-images.githubusercontent.com/105224956/176985192-942f5b1d-b575-4a31-bf02-704b9b5af849.png)

The `cdk.json` file tells the CDK Toolkit how to execute your app.

## Useful commands

- `npm run build` compile typescript to js
- `npm run clean` clean up the build artifacts, included the type files `*.d.js` and main files `*.js`, as well as the artifacts in `cdk.out`
- `npm run watch` watch for changes and compile
- `npm run test` perform the jest unit tests
- `npm run lint` perform eslint with local `eslintrc` and `eslintignore`
- `npm run prettier`perform prettier and auto fix with local `prettierrc`
- `cdk deploy` deploy this stack to your default AWS account/region
- `cdk diff` compare deployed stack with current state
- `cdk synth` emits the synthesized CloudFormation template

## Notes for Lambda Development

1. After you saved your change and built it, you should run `cdk synth` so that the build will trigger the installment of your lambda's dependency. The current bundling asset code is installed by [running the lambda's image](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_lambda-readme.html#bundling-asset-code)
2. Then you can deploy your experimental lambda stack for testing safely by running `cdk deploy <YOUR Lambda Stack Name>`.
3. You can also test your lambda changes locally with SAM as the following
   1. On MacOS, install SAM CLI with `brew tap aws/tap && brew install aws-sam-cli`. Follow [SAM installation wiki](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html) for other OS.
   2. Run `cdk synth --no-staging` to build the SAM template from your latest changes
   3. Identify the template file in cdk.out and run through the test event. For example `sam local invoke -t cdk.out/assembly-StreamDataSourcingPipeline-webroot/<your lambda>.template.json -e python_lambda/index-transform-lambda/testcase.json`

## Notes for OpenSearch Domain
The OpenSearch domain is created and managed outside of this CDK package. More than one data sources (Twitter, Discord, etc) will share and use the same Domain. However different stages will have different domains with different instance types and configs. 

The domain is shared by exporting the `CfnOutput` key value pair with an __export name__. The key is auto generated by CDK and export name is constructed by disambiguator (stageName or developer's alias), the value is the domain arn. When use it, you need to import domain arn by export name `cdk.Fn.importValue(export_name)`. An export name example looks like `dev-uswest2-DomainArn`.
## Notes for OpenSearch Index Template

1. To create index template (necessary for correctly parsing indexing lambda), under `python_lambda`, set your OpenSearch URI, username and password in `create_index_template.sh` and run `bash create_index_template.sh`.
